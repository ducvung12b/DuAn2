{% extends "myapp/base.html" %}
{%load static%}



{%block detail%}
<!--  CSS -->

<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
<link rel="stylesheet" href="{%static "css/fixdetail.css"%}">
<link rel="stylesheet" href="{%static "css/comment.css"%}">

<!--  JS -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="{%static "js/detail.js"%}"></script>







<div class="container">
	<div class="card">
		<div class="container-fliud">
			
			<div class="wrapper row">
				<div class="preview col-md-6">
					
					<div class="preview-pic tab-content">
						{% for image in images|slice:":4" %}
						<div class="tab-pane {% if forloop.first %}active{% endif %}" id="pic-{{ forloop.counter }}">
							<img src="{{ image.image.url }}" style="width: 500px;height: 500px; border: 2px solid #000000;"/>
						</div>
					{% endfor %}
				</div>
			
				<ul class="preview-thumbnail nav nav-tabs">
					{% for image in images|slice:":4" %}
						<li class="{% if forloop.first %}active{% endif %}">
							<a data-target="#pic-{{ forloop.counter }}" data-toggle="tab">
								<img src="{{ image.image.url }}" style="width: 100px;height: 60px;border: 1px solid #0d1214;"/>
							</a>
						</li>
					{% endfor %}
					</ul>
					
				</div>
				<div class="details col-md-6">
					<h3 class="product-title">TÃªn MoÌn Ä‚n : {{recipe.title}}</h3>
					<div class="rating">
						<span class="review-no">LÆ°Æ¡Ì£c Xem : {{ recipe.views }}</span>
                        <p>ÄÃ¡nh giÃ¡ trung bÃ¬nh: {{ recipe.average_rating }}<i class="fa fa-star checked"></i> / 5<i class="fa fa-star checked"></i></p>
					</div>
					<p class="product-title">GiÆ¡Ìi ThiÃªÌ£u : </p> <p>{{recipe.introduce}}</p>
					<h5 class="product-title">mÃ´ taÌ‰ caÌch chÃªÌ biÃªÌn: </h5>
					<p class="product-description">{{recipe.description}}</p>
					
                     
                    <br>
                    <!-- RATING FORM -->
                            <form method="post" action="{% url 'rate_recipe' recipe_id=recipe.id %}">
                                {% csrf_token %}
                                <label for="stars">ÄÃ¡nh GiÃ¡ CÃ´ng ThÆ°Ìc:</label>
                                <div class="star-rating" id="stars">
                                    <span class="star" data-value="1">&#9733;</span>
                                    <span class="star" data-value="2">&#9733;</span>
                                    <span class="star" data-value="3">&#9733;</span>
                                    <span class="star" data-value="4">&#9733;</span>
                                    <span class="star" data-value="5">&#9733;</span>
                                </div>
                                <input type="hidden" id="stars-input" name="stars" value="0" required> <!-- GiÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  0 -->
                                <p style="padding-top: 1px;"></p>
                                <div>
                                    <button type="submit" class="btn btn-primary">Gá»­i Ä‘Ã¡nh giÃ¡</button>
                                    <button  id="recipe-container" type="button" class="btn btn-secondary" data-recipe-id="{{ recipe.id }}">Reset</button>
                                </div>
                            </form>
					<br>



					<div class="action">
						<a href="{% url 'like_recipe' recipe.id %}" class="add-to-cart btn btn-default" type="button">ThiÌch</a>
						<button class="like btn btn-default" type="button">ğ–¤‚</button>
					</div>
				</div>
			</div>
			
		</div>
	</div>
</div>


<br><br>

<!-- Hiá»ƒn thá»‹ danh sÃ¡ch vaÌ€ sÃ´Ì lÆ°Æ¡Ì£ng bÃ¬nh luáº­n -->
<h3>NhÆ°Ìƒng ÄaÌnh GiaÌ KhaÌc ({{ total_count }}) :</h3>
<br>

<!-- Kiá»ƒm tra xem comment cÃ³ reply hay khÃ´ng -->
{% if comments.count > 0 %}

 <!-- Container bá»c toÃ n bá»™ reply (chá»‰ hiá»ƒn thá»‹ náº¿u cÃ³ reply) -->
<div style="max-height: 600px;  overflow-y: auto; border: 4px solid #e8ea61; padding: 10px; border-radius: 5px;">


<div class="comments-section" style="padding-left: 50px; width: 90%;">
    {% for comment in comments %}
        <div class="comment" style="padding-top: 20px;">
            <p style="border-bottom: 1px solid #000000;"></p>
            <p><strong>{{ comment.user.username }}</strong> - {{ comment.created_at }}</p>
            <p>{{ comment.content }}</p>

            <!-- NÃºt duy nháº¥t Ä‘á»ƒ xem reply vÃ  form tráº£ lá»i -->
            <a href="#" class="toggle-replies-button" data-comment-id="{{ comment.id }}">Xem Tráº£ lá»i</a>

            <!-- Form tráº£ lá»i vÃ  reply, áº©n máº·c Ä‘á»‹nh -->
            <div class="reply-section" id="reply-section-{{ comment.id }}" style="display: none; padding-left: 40px;">
                
                 <!-- Kiá»ƒm tra xem comment cÃ³ reply hay khÃ´ng -->
                 {% if comment.replies.count > 0 %}

                 <!-- Container bá»c toÃ n bá»™ reply (chá»‰ hiá»ƒn thá»‹ náº¿u cÃ³ reply) -->
                 <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ffffff; padding: 10px; border-radius: 5px;">

                    <!-- Hiá»ƒn thá»‹ reply --> 
                    <div class="replies"  >
                        {% for reply in comment.replies.all %}
                            <div class="reply">
                                <p><strong>{{ reply.user.username }}</strong> - {{ reply.created_at }}</p>
                                <p>{{ reply.content }}</p>

                                <p style="border-bottom: 1px solid #000000;"></p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <!-- Form tráº£ lá»i -->
                 <h5>NhÃ¢Ì£p BiÌ€nh LuÃ¢Ì£n CuÌ‰a BaÌ£n :</h5>
                <form method="POST" class="reply-form" id="reply-form-{{ comment.id }}">
                    {% csrf_token %}
                    <textarea style="height: 45px;" name="content" rows="2" placeholder="NhÃ¢Ì£p VaÌ€o ÄÃ¢y......" class="form-control"></textarea>
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <br>
                    <button type="submit" class="btn btn-primary">TraÌ‰ LÆ¡Ì€i</button>
                </form>
            </div>
        </div>
    {% endfor %}
</div>
</div>
{% endif %}


<!-- Form bÃ¬nh luáº­n -->
<h2 style="background-color: rgb(237, 228, 155);">BiÌ€nh LuÃ¢Ì£n CÃ´ng ThÆ°Ìc {{ recipe.title }} : </h2>
<form method="POST" style="padding-left: 50px; width: 90%;">
    {% csrf_token %}
    

    <!-- Táº¡o label vÃ  trÆ°á»ng nháº­p liá»‡u cho form -->
    <div class="form-group" >
        <label for="id_content">NhÃ¢Ì£p BiÌ€nh LuÃ¢Ì£n CuÌ‰a BaÌ£n :</label>
		<br>
        <textarea style="height: 45px;" id="id_content" name="content" rows="3" placeholder="NhÃ¢Ì£p VaÌ€o ÄÃ¢y......" class="form-control">{{ form.content.value }}</textarea>
		<br>
		<button type="submit" class="btn btn-primary" style="padding-top: 10px;">BiÌ€nh LuÃ¢Ì£n</button>
        <br>
        <p></p>
		
	</div>

    
</form>



<!-- JavaScript Ä‘á»ƒ hiá»ƒn thá»‹ reply vÃ  form tráº£ lá»i -->
<script>
    document.querySelectorAll('.toggle-replies-button').forEach(function(button) {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            var commentId = this.getAttribute('data-comment-id');
            var replySection = document.getElementById('reply-section-' + commentId);

            // Chuyá»ƒn Ä‘á»•i hiá»ƒn thá»‹ pháº§n reply vÃ  form tráº£ lá»i
            if (replySection.style.display === 'none' || replySection.style.display === '') {
                replySection.style.display = 'block';
                this.textContent = 'áº¨n Tráº£ lá»i';
            } else {
                replySection.style.display = 'none';
                this.textContent = 'Xem Tráº£ lá»i';
            }
        });
    });
</script>

<p style="padding-bottom: 100px;"></p>



<!-- RATING -->
<script>
const stars = document.querySelectorAll('.star');
const starsInput = document.getElementById('stars-input');
const resetButton = document.querySelector('.btn-secondary'); // NÃºt reset

stars.forEach(star => {
    star.addEventListener('click', () => {
        const value = star.getAttribute('data-value');
        starsInput.value = value; // GÃ¡n giÃ¡ trá»‹ vÃ o input áº©n
        updateStars(value);
    });
});

// HÃ m cáº­p nháº­t ngÃ´i sao
function updateStars(value) {
    stars.forEach(star => {
        if (parseInt(star.getAttribute('data-value')) <= parseInt(value)) {
            star.classList.add('filled');
        } else {
            star.classList.remove('filled');
        }
    });
}

// HÃ m xá»­ lÃ½ khi báº¥m nÃºt reset
resetButton.addEventListener('click', () => {
    starsInput.value = 0; // Äáº·t giÃ¡ trá»‹ input áº©n thÃ nh 0
    stars.forEach(star => {
        star.classList.remove('filled'); // XÃ³a cÃ¡c ngÃ´i sao Ä‘Ã£ Ä‘Æ°á»£c chá»n
    });
});


const recipeId = document.getElementById('recipe-container').getAttribute('data-recipe-id');

// NÃºt reset Ä‘Ã£ cÃ³
resetButton.addEventListener('click', () => {
    const recipeId = "{{ recipe.id }}"; // Äáº£m báº£o báº¡n truyá»n Ä‘Ãºng recipe ID tá»« template
    
    // Gá»­i yÃªu cáº§u POST Ä‘á»ƒ reset Ä‘Ã¡nh giÃ¡
    fetch(`/recipe/${recipeId}/reset_rating/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}', // Gá»­i CSRF token
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Lá»—i khi reset Ä‘Ã¡nh giÃ¡');
        }
    })
    .then(data => {
        alert(data.message); // ThÃ´ng bÃ¡o khi reset thÃ nh cÃ´ng
        location.reload(); // Tá»± Ä‘á»™ng táº£i láº¡i trang
    })
    .catch(error => {
        console.error('Error:', error);
    });
});


</script>



<style>
.star-rating {
    display: flex;
    cursor: pointer;
}

.star {
    font-size: 2rem;
    color: #ccc; /* MÃ u cho ngÃ´i sao chÆ°a Ä‘Æ°á»£c chá»n */
}

.star.filled {
    color: #ec9a3b; /* MÃ u cho ngÃ´i sao Ä‘Æ°á»£c chá»n */
}
</style>
  {% endblock detail%}